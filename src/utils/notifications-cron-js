// src/utils/notifications-cron.js
import cron from "node-cron";
import Notification from "../models/Notification.js";
import { dispatchEmailForNotification } from "../services/notification.service.js";

export function registerNotificationsCron() {
  // cada minuto
  cron.schedule("* * * * *", async () => {
    const now = new Date();
    try {
      // limit para no bloquear el event loop si hay muchas
      const due = await Notification.find({
        status: "pending",
        channel: "email",
        notBefore: { $lte: now }
      })
        .sort({ notBefore: 1 })
        .limit(50)
        .lean();

      for (const n of due) {
        await dispatchEmailForNotification(n);
      }
    } catch (e) {
      console.error("notifications-cron error:", e?.message || e);
    }
  });
}
